"use strict";var k=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var G=Object.getOwnPropertyNames;var I=Object.prototype.hasOwnProperty;var H=(n,e)=>{for(var o in e)k(n,o,{get:e[o],enumerable:!0})},$=(n,e,o,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let t of G(e))!I.call(n,t)&&t!==o&&k(n,t,{get:()=>e[t],enumerable:!(r=B(e,t))||r.enumerable});return n};var z=n=>$(k({},"__esModule",{value:!0}),n);var J={};H(J,{Mouse:()=>x,MouseError:()=>p});module.exports=z(J);var W=require("events");var p=class extends Error{constructor(o,r){super(o);this.originalError=r;this.name="MouseError"}};var y=class{constructor(e){this.emitter=e}async*eventsOf(e,{latestOnly:o=!1,maxQueue:r=100,signal:t}={}){if(t?.aborted)throw new Error("The operation was aborted.");let s=[],a=[],d=Math.min(r,1e3),i=null,v=null,u=null,l=c=>{v?(v(c),v=null,u=null,i=null):o?i=c:(s.length>=d&&s.shift(),s.push(c))},f=c=>{let E=new p(`Error in mouse event stream: ${c.message}`,c);u?(u(E),v=null,u=null):a.push(E)},m=()=>{let c=new p("The operation was aborted.");u?(u(c),v=null,u=null):a.push(c)};this.emitter.on(e,l),this.emitter.on("error",f),t?.addEventListener("abort",m);try{for(;;){if(t?.aborted)throw new p("The operation was aborted.");if(a.length>0)throw a.shift();if(s.length>0){let c=s.shift();c&&(yield c)}else if(i!==null){let c=i;i=null,yield c}else yield await new Promise((c,E)=>{v=c,u=E})}}finally{this.emitter.off(e,l),this.emitter.off("error",f),t?.removeEventListener("abort",m)}}async*debouncedMoveEvents({interval:e=16,signal:o}={}){if(o?.aborted)throw new p("The operation was aborted.");let r=null,t=null,s=null,a=null,d=[],i=l=>{r=l,t!==null&&clearTimeout(t),t=setTimeout(()=>{if(r!==null&&s!==null){let f=r;r=null,s(f),s=null,a=null}},e)},v=l=>{let f=new p(`Error in mouse event stream: ${l.message}`,l);a?(a(f),s=null,a=null):d.push(f)},u=()=>{let l=new p("The operation was aborted.");a?(a(l),s=null,a=null):d.push(l)};this.emitter.on("move",i),this.emitter.on("error",v),o?.addEventListener("abort",u);try{for(;;){if(o?.aborted)throw new p("The operation was aborted.");if(d.length>0)throw d.shift();if(r!==null&&t===null){let l=r;r=null,yield l}else yield await new Promise((l,f)=>{s=l,a=f})}}finally{t!==null&&clearTimeout(t),this.emitter.off("move",i),this.emitter.off("error",v),o?.removeEventListener("abort",u)}}async*stream({latestOnly:e=!1,maxQueue:o=1e3,signal:r}={}){if(r?.aborted)throw new Error("The operation was aborted.");let t=[],s=[],a=null,d=null,i=null,v=new Map,u=["press","release","drag","wheel","move","click"];u.forEach(m=>{let c=E=>{let R={type:m,event:E};d?(d(R),d=null,i=null,a=null):e?a=R:(t.length>=o&&t.shift(),t.push(R))};v.set(m,c),this.emitter.on(m,c)});let l=m=>{let c=new p(`Error in mouse event stream: ${m.message}`,m);i?(i(c),d=null,i=null):s.push(c)};this.emitter.on("error",l);let f=()=>{let m=new p("The operation was aborted.");i?(i(m),d=null,i=null):s.push(m)};r?.addEventListener("abort",f);try{for(;;){if(r?.aborted)throw new p("The operation was aborted.");if(s.length>0)throw s.shift();if(t.length>0){let m=t.shift();m&&(yield m)}else if(a!==null){let m=a;a=null,yield m}else yield await new Promise((m,c)=>{d=m,i=c})}}finally{u.forEach(m=>{let c=v.get(m);c&&this.emitter.off(m,c)}),this.emitter.off("error",l),r?.removeEventListener("abort",f)}}};var M=class{constructor(e,o){this.emitter=e;this.getLastPosition=o}async waitForClick({timeout:e=3e4,signal:o}={}){if(o?.aborted)throw new p("The operation was aborted.");return new Promise((r,t)=>{let s=setTimeout(()=>{i(),t(new p(`Timeout waiting for click after ${e}ms`))},e),a=()=>{i(),t(new p("The operation was aborted."))},d=v=>{i(),r(v)},i=()=>{clearTimeout(s),o?.removeEventListener("abort",a),this.emitter.off("click",d)};o?.addEventListener("abort",a),this.emitter.on("click",d)})}async waitForInput({timeout:e=3e4,signal:o}={}){if(o?.aborted)throw new p("The operation was aborted.");return new Promise((r,t)=>{let s=setTimeout(()=>{u(),t(new p(`Timeout waiting for input after ${e}ms`))},e),a=()=>{u(),t(new p("The operation was aborted."))},d=["press","release","drag","wheel","move","click"],i=new Map,v=l=>f=>{u(),r(f)},u=()=>{clearTimeout(s),o?.removeEventListener("abort",a),i.forEach((l,f)=>{this.emitter.off(f,l)})};o?.addEventListener("abort",a),d.forEach(l=>{let f=v(l);i.set(l,f),this.emitter.on(l,f)})})}async getMousePosition({timeout:e=3e4,signal:o}={}){if(o?.aborted)throw new p("The operation was aborted.");let r=this.getLastPosition();return r!==null?r:new Promise((t,s)=>{let a=setTimeout(()=>{v(),s(new p(`Timeout waiting for mouse position after ${e}ms`))},e),d=()=>{v(),s(new p("The operation was aborted."))},i=u=>{v(),t({x:u.x,y:u.y})},v=()=>{clearTimeout(a),o?.removeEventListener("abort",d),this.emitter.off("move",i)};o?.addEventListener("abort",d),this.emitter.on("move",i)})}};function b(n,e=new WeakSet){if(n===null||typeof n!="object"||e.has(n))return n;if(e.add(n),[Date,RegExp,Error,URL,File,Blob].some(t=>n instanceof t))return Object.freeze(n);if(n instanceof Map){for(let[t,s]of n.entries())b(t,e),b(s,e);return Object.freeze(n)}if(n instanceof Set){for(let t of n.values())b(t,e);return Object.freeze(n)}if(n instanceof WeakMap||n instanceof WeakSet)return Object.freeze(n);let r=Object.getOwnPropertyNames(n);for(let t of r){let s=n[t];b(s,e)}return Object.freeze(n)}var A=b({sgr:21,esc:6}),h=b({mouseButton:{on:"\x1B[?1000h",off:"\x1B[?1000l"},mouseDrag:{on:"\x1B[?1002h",off:"\x1B[?1002l"},mouseMotion:{on:"\x1B[?1003h",off:"\x1B[?1003l"},mouseSGR:{on:"\x1B[?1006h",off:"\x1B[?1006l"}}),P={sgrPattern:/^\x1b\[<(\d{1,3});(\d{1,4});(\d{1,4})([Mm])/,escPattern:/^\x1b\[M([\x20-\x7f])([\x20-\x7f])([\x20-\x7f])/};function Y(n){let e=!!(n&32),r=n&~60,t;switch(r){case 0:t="left";break;case 1:t="middle";break;case 2:t="right";break;case 3:t="none";break;case 64:t="wheel-up";break;case 65:t="wheel-down";break;case 66:t="wheel-left";break;case 67:t="wheel-right";break;case 128:t="back";break;case 129:t="forward";break;default:t="unknown";break}let s;return e?s=t==="none"?"move":"drag":t.startsWith("wheel-")?s="wheel":s="press",{button:t,action:s}}function _(n){let e=!!(n&32),o="unknown";if(n&64)switch(n){case 64:o="wheel-up";break;case 65:o="wheel-down";break;case 66:o="wheel-left";break;case 67:o="wheel-right";break;default:o="unknown";break}else switch(n&3){case 0:o="left";break;case 1:o="middle";break;case 2:o="right";break;case 3:o="none";break}let r;return e?r=o==="none"?"move":"drag":o.startsWith("wheel-")?r="wheel":(n&3)===3?r="release":r="press",{button:o,action:r}}function Q(n,e){let r=n.slice(e,e+A.sgr).match(P.sgrPattern);if(!r)return[null,e+1];let[t,s,a,d,i]=r,v=i==="m",u=parseInt(s,10),l=parseInt(a,10),f=parseInt(d,10);if(Number.isNaN(u)||Number.isNaN(l)||Number.isNaN(f))return[null,e+1];let{button:m,action:c}=Y(u);return[{protocol:"SGR",x:l,y:f,button:m,action:v?"release":c,shift:!!(u&4),alt:!!(u&8),ctrl:!!(u&16),raw:u,data:t},e+t.length]}function U(n,e){let r=n.slice(e,e+A.esc).match(P.escPattern);if(!r)return[null,e+1];let[t,s,a,d]=r,i=s.charCodeAt(0)-32,v=a.charCodeAt(0)-32,u=d.charCodeAt(0)-32,{button:l,action:f}=_(i);return[{protocol:"ESC",x:v,y:u,button:l,action:f,shift:!!(i&4),alt:!!(i&8),ctrl:!!(i&16),raw:i,data:t},e+t.length]}function*L(n){let e=0,o=null;for(;e<n.length;){let r=n.indexOf("\x1B[",e);if(r===-1)break;e=r;let t=null,s;n[e+2]==="<"?[t,s]=Q(n,e):n[e+2]==="M"?[t,s]=U(n,e):s=e+2,t&&t.data!==o&&(yield t,o=t.data),e=s}}var w=class{lastPress=null;clickDistanceThreshold;constructor(e){this.clickDistanceThreshold=e?.clickDistanceThreshold??1}processEvent(e,o){if(e.action==="press")this.lastPress=e;else if(e.action==="release"){if(this.lastPress){let r=Math.abs(e.x-this.lastPress.x),t=Math.abs(e.y-this.lastPress.y);if(r<=this.clickDistanceThreshold&&t<=this.clickDistanceThreshold){let s={...e,action:"click"};process.nextTick(()=>{o(s)})}}this.lastPress=null}}reset(){this.lastPress=null}};var T=class{lastPosition=null;processEvent(e){(e.action==="move"||e.action==="drag")&&(this.lastPosition={x:e.x,y:e.y})}getLastPosition(){return this.lastPosition}reset(){this.lastPosition=null}};var g=class{constructor(e,o){this.emitter=e;this.clickDetector=new w(o),this.positionTracker=new T}clickDetector;positionTracker;handleEvent=(e,o)=>{if(!o)try{let r=L(e.toString());for(let t of r)this.positionTracker.processEvent(t),this.emitter.emit(t.action,t),this.clickDetector.processEvent(t,s=>{this.emitter.emit("click",s)})}catch(r){this.emitter.emit("error",r)}};on=(e,o)=>this.emitter.on(e,o);off=(e,o)=>this.emitter.off(e,o);once=(e,o)=>{let r=(...t)=>{this.emitter.off(e,r),o(...t)};return this.emitter.on(e,r)};getEmitter(){return this.emitter}getLastPosition(){return this.positionTracker.getLastPosition()}removeAllListeners(){this.emitter.removeAllListeners()}reset(){this.clickDetector.reset(),this.positionTracker.reset()}};function N(n,e,o){if(typeof n!="object"||n===null)throw new TypeError(`[xterm-mouse] ${o} must be an object, got ${typeof n=="object"?"null":typeof n}`);for(let r of e){let t=n[r];if(typeof t!="function")throw new TypeError(`[xterm-mouse] ${o} must have method ${r}(), but ${typeof t>"u"?"it is missing":`it has type ${typeof t}`}`)}}function D(n,e){if(typeof n!="function")throw new TypeError(`[xterm-mouse] ${e} must be a function, got ${typeof n}`)}function C(n,e){N(n,["write"],e)}function O(n,e){N(n,["on","off","pause","resume"],e)}var F=new FinalizationRegistry(n=>{try{n.inputStream.off("data",n.handleEvent)}catch{}try{n.isRaw&&(n.setRawModeFn?n.setRawModeFn(!1):n.inputStream.setRawMode(!1)),n.inputStream.pause()}catch{}try{n.outputStream.write(h.mouseSGR.off+h.mouseMotion.off+h.mouseDrag.off+h.mouseButton.off)}catch{}}),S=class{constructor(e,o,r,t){this.inputStream=e;this.outputStream=o;this.handleEvent=r;this.setRawModeFn=t;O(e,"inputStream"),C(o,"outputStream"),D(r,"handleEvent"),t!==void 0&&D(t,"setRawModeFn")}enabled=!1;paused=!1;previousEncoding=null;previousRawMode=null;currentRawMode=null;cleanupToken=null;setRawMode(e){this.setRawModeFn?this.setRawModeFn(e):this.inputStream.setRawMode(e)}enable=()=>{if(!this.enabled){if(!this.inputStream.isTTY)throw new Error("Mouse events require a TTY input stream");try{this.previousRawMode=this.setRawModeFn?this.currentRawMode??!1:this.inputStream.isRaw??!1,this.previousEncoding=this.inputStream.readableEncoding||null,this.enabled=!0,this.outputStream.write(h.mouseButton.on+h.mouseDrag.on+h.mouseMotion.on+h.mouseSGR.on),this.setRawMode(!0),this.currentRawMode=!0,this.inputStream.setEncoding("utf8"),this.inputStream.resume(),this.inputStream.on("data",this.handleEvent),this.cleanupToken={instance:this},F.register(this,{inputStream:this.inputStream,handleEvent:this.handleEvent,outputStream:this.outputStream,previousRawMode:this.previousRawMode,isRaw:this.inputStream.isRaw??!1,setRawModeFn:this.setRawModeFn},this.cleanupToken)}catch(e){throw this.enabled=!1,new p(`Failed to enable mouse: ${e instanceof Error?e.message:String(e)}`,e instanceof Error?e:void 0)}}};disable=()=>{if(this.enabled)try{this.cleanupToken&&(F.unregister(this.cleanupToken),this.cleanupToken=null),this.inputStream.off("data",this.handleEvent),this.inputStream.pause(),this.previousRawMode!==null&&(this.setRawMode(this.previousRawMode),this.currentRawMode=this.previousRawMode),this.previousEncoding!==null&&this.inputStream.setEncoding(this.previousEncoding),this.outputStream.write(h.mouseSGR.off+h.mouseMotion.off+h.mouseDrag.off+h.mouseButton.off)}catch(e){throw new p(`Failed to disable mouse: ${e instanceof Error?e.message:String(e)}`,e instanceof Error?e:void 0)}finally{this.enabled=!1,this.previousRawMode=null,this.previousEncoding=null,this.currentRawMode=null}};pause=()=>{this.paused||(this.paused=!0)};resume=()=>{this.paused&&(this.paused=!1)};isEnabled(){return this.enabled}isPaused(){return this.paused}destroy(){this.disable(),this.cleanupToken&&(F.unregister(this.cleanupToken),this.cleanupToken=null)}};var x=class n{tty;eventManager;streamFactory;convenience;static SupportCheckResult={Supported:"supported",NotTTY:"not_tty",OutputNotTTY:"output_not_tty"};constructor(e){let o=e?.inputStream??process.stdin,r=e?.outputStream??process.stdout,t=e?.emitter??new W.EventEmitter;this.eventManager=new g(t,e),this.tty=new S(o,r,s=>this.eventManager.handleEvent(s,this.tty.isPaused()),e?.setRawMode),this.streamFactory=new y(this.eventManager.getEmitter()),this.convenience=new M(this.eventManager.getEmitter(),()=>this.eventManager.getLastPosition())}static isSupported(e,o){return n.checkSupport({inputStream:e,outputStream:o})===n.SupportCheckResult.Supported}static checkSupport(e){let o=e?.inputStream??process.stdin,r=e?.outputStream??process.stdout;return o.isTTY?r.isTTY?n.SupportCheckResult.Supported:n.SupportCheckResult.OutputNotTTY:n.SupportCheckResult.NotTTY}enable=()=>{this.tty.enable()};disable=()=>{this.tty.disable()};pause=()=>{this.tty.pause()};resume=()=>{this.tty.resume()};on=(e,o)=>this.eventManager.on(e,o);off=(e,o)=>this.eventManager.off(e,o);once=(e,o)=>this.eventManager.once(e,o);async*eventsOf(e,o){yield*this.streamFactory.eventsOf(e,o)}async*debouncedMoveEvents(e){yield*this.streamFactory.debouncedMoveEvents(e)}async*stream(e){yield*this.streamFactory.stream(e)}isEnabled(){return this.tty.isEnabled()}isPaused(){return this.tty.isPaused()}destroy(){this.tty.destroy(),this.eventManager.removeAllListeners()}async waitForClick(e){return this.convenience.waitForClick(e)}async waitForInput(e){return this.convenience.waitForInput(e)}getLastPosition(){return this.eventManager.getLastPosition()}async getMousePosition(e){return this.convenience.getMousePosition(e)}};0&&(module.exports={Mouse,MouseError});
//# sourceMappingURL=index.cjs.map